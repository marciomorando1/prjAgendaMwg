{% extends 'core/base.html' %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Atividade #{{ object.numero }}</h5>
        <p class="mb-1"><strong>Cliente:</strong> {{ object.nome_cliente }}</p>
        <p class="mb-1"><strong>Orçamento:</strong> {{ object.numero_orcamento }}</p>
        <p class="mb-1"><strong>Serviço:</strong> {{ object.servico}} </p>
        <p class="mb-1"><strong>Descrição:</strong> {{ object.descricao }}</p>
        <p class="mb-1"><strong>Recurso:</strong> {{ object.recurso }}</p>
        <p class="mb-1"><strong>Previsto:</strong> {{ object.inicio_previsto }} → {{ object.fim_previsto }}</p>
        {% comment %} <p class="mb-1"><strong>Percentual:</strong> {{ object.percentual_concluido }}%</p> {% endcomment %}
        {% if object.anexo %}
          <p class="mb-1"><strong>Anexo:</strong> <a href="{{ object.anexo.url }}" target="_blank">baixar</a></p>
        {% endif %}
        <p class="mb-0"><strong>Descrição:</strong><br>{{ object.descricao|default:"—" }}</p>
        <div class="mt-3">
          {% if request.user.gerente_projetos %}
            <a class="btn btn-sm btn-outline-primary" href="{% url 'activity_update' object.numero %}">Editar</a>
            <a class="btn btn-sm btn-outline-danger" href="{% url 'activity_delete' object.numero %}">Excluir</a>
            
            <form method="post" action="{% url 'activity_start_workflow' object.numero %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-warning">Gerar BPM</button>
            </form>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  {% comment %} <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Apontar Execução</h5>
        {% if request.user.gerente_projetos or request.user == object.recurso %}
        <form method="post" action="{% url 'log_create' object.numero %}">{% csrf_token %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Início</label>
              {{ log_form.inicio }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Fim</label>
              {{ log_form.fim }}
            </div>
            <div class="col-12">
              <label class="form-label">Descrição</label>
              {{ log_form.descricao }}
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-success">Registrar Apontamento</button>
          </div>
        </form>
        {% else %}
          <div class="alert alert-warning">Somente o recurso atribuído ou um gerente pode apontar tempo.</div>
        {% endif %}
      </div>
    </div>
    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h6 class="card-title">Histórico de Apontamentos</h6>
        <ul class="list-group">
          {% for log in object.logs.all %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <div><strong>{{ log.usuario }}</strong> — {{ log.inicio }} → {{ log.fim|default:"(em andamento)" }}</div>
                <small>{{ log.descricao|default:"" }}</small>
              </div>
            </li>
          {% empty %}
            <li class="list-group-item">Sem apontamentos ainda.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div> {% endcomment %}

{% endblock %}
